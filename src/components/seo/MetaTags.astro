---
/**
 * SEO Meta Tags Component for ClearLane Initiative
 * Comprehensive meta tags with Open Graph and Twitter Card support
 */

export interface Props {
  title: string;
  description: string;
  canonical?: string;
  ogImage?: string;
  ogType?: 'website' | 'article' | 'profile';
  article?: {
    publishedTime?: string;
    modifiedTime?: string;
    author?: string;
    section?: string;
    tags?: string[];
  };
  twitter?: {
    card?: 'summary' | 'summary_large_image' | 'app' | 'player';
    site?: string;
    creator?: string;
  };
  robots?: string;
  viewport?: string;
  themeColor?: string;
  keywords?: string[];
  lang?: string;
  schema?: object;
}

const {
  title,
  description,
  canonical = Astro.url.href,
  ogImage = '/images/clearlane-og-default.jpg',
  ogType = 'website',
  article,
  twitter = {
    card: 'summary_large_image',
    site: '@ClearLaneNYC',
    creator: '@ClearLaneNYC'
  },
  robots = 'index, follow',
  viewport = 'width=device-width, initial-scale=1, shrink-to-fit=no',
  themeColor = '#1e40af',
  keywords = [],
  lang = 'en',
  schema
} = Astro.props;

// Site configuration
const siteConfig = {
  name: 'ClearLane Initiative',
  url: 'https://clearlane.org',
  description: 'Data-driven advocacy for better NYC bus lane enforcement',
  author: 'ClearLane Initiative Team',
  twitter: '@ClearLaneNYC',
  facebook: 'ClearLaneInitiative'
};

// Generate absolute URL for images
const getAbsoluteUrl = (url: string) => {
  if (url.startsWith('http')) return url;
  return new URL(url, siteConfig.url).href;
};

// Combine default and custom keywords
const allKeywords = [
  'NYC bus lanes',
  'public transit',
  'transportation policy',
  'bus enforcement',
  'traffic violations',
  'urban planning',
  'data analysis',
  'public policy',
  'transit advocacy',
  'CUNY research',
  ...keywords
];

// Generate JSON-LD schema
const defaultSchema = {
  '@context': 'https://schema.org',
  '@type': ogType === 'article' ? 'Article' : 'WebPage',
  name: title,
  headline: title,
  description: description,
  url: canonical,
  image: getAbsoluteUrl(ogImage),
  publisher: {
    '@type': 'Organization',
    name: siteConfig.name,
    url: siteConfig.url,
    logo: {
      '@type': 'ImageObject',
      url: getAbsoluteUrl('/images/clearlane-logo.png')
    }
  },
  author: {
    '@type': 'Person',
    name: siteConfig.author
  },
  ...(article?.publishedTime && {
    datePublished: article.publishedTime
  }),
  ...(article?.modifiedTime && {
    dateModified: article.modifiedTime
  }),
  ...(article?.section && {
    articleSection: article.section
  }),
  ...(article?.tags && {
    keywords: article.tags.join(', ')
  })
};

const finalSchema = schema || defaultSchema;
---

<!-- Basic Meta Tags -->
<meta charset="utf-8" />
<meta name="viewport" content={viewport} />
<meta name="theme-color" content={themeColor} />
<meta name="robots" content={robots} />
<meta name="language" content={lang} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />
<meta name="author" content={siteConfig.author} />
{keywords.length > 0 && <meta name="keywords" content={allKeywords.join(', ')} />}

<!-- Canonical URL -->
<link rel="canonical" href={canonical} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={ogType} />
<meta property="og:url" content={canonical} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={getAbsoluteUrl(ogImage)} />
<meta property="og:image:alt" content={`${title} - ${siteConfig.name}`} />
<meta property="og:site_name" content={siteConfig.name} />
<meta property="og:locale" content="en_US" />

{article && (
  <>
    <meta property="article:published_time" content={article.publishedTime} />
    {article.modifiedTime && <meta property="article:modified_time" content={article.modifiedTime} />}
    {article.author && <meta property="article:author" content={article.author} />}
    {article.section && <meta property="article:section" content={article.section} />}
    {article.tags && article.tags.map(tag => (
      <meta property="article:tag" content={tag} />
    ))}
  </>
)}

<!-- Twitter -->
<meta property="twitter:card" content={twitter.card} />
<meta property="twitter:url" content={canonical} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={getAbsoluteUrl(ogImage)} />
<meta property="twitter:image:alt" content={`${title} - ${siteConfig.name}`} />
{twitter.site && <meta property="twitter:site" content={twitter.site} />}
{twitter.creator && <meta property="twitter:creator" content={twitter.creator} />}

<!-- Additional Social Media -->
<meta property="fb:app_id" content="your-facebook-app-id" />

<!-- Apple Touch Icon -->
<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png" />
<link rel="manifest" href="/site.webmanifest" />
<link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color={themeColor} />
<meta name="msapplication-TileColor" content={themeColor} />

<!-- Preconnect to external domains -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link rel="preconnect" href="https://www.google-analytics.com" />

<!-- DNS Prefetch for performance -->
<link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
<link rel="dns-prefetch" href="https://unpkg.com" />

<!-- Structured Data -->
<script type="application/ld+json" set:html={JSON.stringify(finalSchema)} />

<!-- Additional Schema for Organization -->
<script type="application/ld+json" set:html={JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: siteConfig.name,
  url: siteConfig.url,
  logo: getAbsoluteUrl('/images/clearlane-logo.png'),
  description: siteConfig.description,
  sameAs: [
    `https://twitter.com/${siteConfig.twitter.replace('@', '')}`,
    `https://facebook.com/${siteConfig.facebook}`
  ],
  contactPoint: {
    '@type': 'ContactPoint',
    contactType: 'Public Relations',
    email: 'contact@clearlane.org'
  }
})} />

<!-- Breadcrumb Schema (if applicable) -->
{Astro.url.pathname !== '/' && (
  <script type="application/ld+json" set:html={JSON.stringify({
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    itemListElement: [
      {
        '@type': 'ListItem',
        position: 1,
        name: 'Home',
        item: siteConfig.url
      },
      {
        '@type': 'ListItem',
        position: 2,
        name: title,
        item: canonical
      }
    ]
  })} />
)}

<!-- Security Headers -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://www.google-analytics.com;" />
<meta http-equiv="X-Content-Type-Options" content="nosniff" />
<meta http-equiv="X-Frame-Options" content="DENY" />
<meta http-equiv="X-XSS-Protection" content="1; mode=block" />
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />

<!-- Preload critical resources -->
<link rel="preload" href="/css/critical.css" as="style" />

<!-- RSS Feed -->
<link rel="alternate" type="application/rss+xml" title={`${siteConfig.name} - Latest Updates`} href="/feed.xml" />

<!-- Sitemap -->
<link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />

<!-- Search Console Verification -->
<meta name="google-site-verification" content="your-google-verification-code" />
<meta name="msvalidate.01" content="your-bing-verification-code" />

<!-- Analytics and Tracking -->
<!-- Google Tag Manager -->
<script type="text/partytown">
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-XXXXXXX');
</script>

<!-- Microsoft Clarity -->
<script type="text/partytown">
  (function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
  })(window, document, "clarity", "script", "your-clarity-id");
</script>

<style>
  /* Critical CSS that needs to be inline */
  html {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  /* Prevent FOUT (Flash of Unstyled Text) */

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    :root {
      --color-text: #000000;
      --color-background: #ffffff;
      --color-primary: #0000ff;
    }
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    :root {
      --color-text: #ffffff;
      --color-background: #1a1a1a;
      --color-primary: #4f46e5;
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
</style>

<!-- Fallback for JavaScript disabled -->
<noscript>
  <style>
    .js-only {
      display: none !important;
    }
    .no-js-fallback {
      display: block !important;
    }
  </style>

  <!-- Google Tag Manager (noscript) -->
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-XXXXXXX"
          height="0" width="0" style="display:none;visibility:hidden" aria-hidden="true"></iframe>
</noscript>