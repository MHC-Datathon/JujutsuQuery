---
/**
 * Research Methodology Page - ClearLane Initiative
 * Transparent documentation of data analysis approach
 */

import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/shared/Header.astro';
import Hero from '../components/sections/Hero.astro';
import Card from '../components/ui/Card.astro';
import Button from '../components/ui/Button.astro';
import DataVisualizationLayout from '../components/layout/DataVisualizationLayout.astro';

const pageTitle = 'Research Methodology - ClearLane Initiative';
const pageDescription = 'Transparent documentation of our data science approach: how we analyzed 3.7 million MTA violation records to identify enforcement failures affecting CUNY students.';

const dataSources = [
  {
    name: 'MTA Bus Automated Camera Enforcement Violations',
    records: '3,778,568',
    timeframe: 'October 2019 - August 2025',
    description: 'Complete violation records including location, time, route, and enforcement status',
    source: 'NYC Open Data'
  },
  {
    name: 'MTA Bus Speed Data',
    records: '2.1M+',
    timeframe: '2015 - 2025',
    description: 'Average speeds by route and time period for before/after analysis',
    source: 'MTA GTFS Feed'
  },
  {
    name: 'CUNY Campus Locations',
    records: '25',
    timeframe: 'Current',
    description: 'Coordinates and enrollment data for proximity analysis',
    source: 'CUNY Institutional Research'
  },
  {
    name: 'Bus Route Geometry',
    records: '300+',
    timeframe: 'Current',
    description: 'GTFS route shapes and stop locations for spatial analysis',
    source: 'MTA GTFS Static'
  }
];

const analysisSteps = [
  {
    step: '1',
    title: 'Data Integration',
    description: 'Combined violation records with bus stop locations using spatial joins',
    technical: 'GeoPandas spatial join with 50m tolerance, matched 97.8% of records',
    icon: 'üîó'
  },
  {
    step: '2',
    title: 'Temporal Analysis',
    description: 'Identified peak violation patterns by hour, day, and academic calendar',
    technical: 'Pandas groupby operations, datetime indexing, statistical significance testing',
    icon: '‚è∞'
  },
  {
    step: '3',
    title: 'CUNY Proximity Mapping',
    description: 'Calculated distances from violations to CUNY campuses using buffer analysis',
    technical: 'Haversine distance formula, 500m buffer zones, spatial indexing',
    icon: 'üéì'
  },
  {
    step: '4',
    title: 'Enforcement Paradox Calculation',
    description: 'Developed metric combining violation intensity with speed improvement',
    technical: 'Custom scoring: (violations √ó intensity) / speed_improvement_factor',
    icon: 'üìä'
  },
  {
    step: '5',
    title: 'Impact Quantification',
    description: 'Estimated time lost and academic disruption for student populations',
    technical: 'Monte Carlo simulation with ridership data, confidence intervals',
    icon: 'üìà'
  }
];

const codeRepositories = [
  {
    name: 'Jupyter Notebooks',
    description: 'Complete analysis pipeline with reproducible results',
    files: '4 notebooks',
    link: '/notebooks/'
  },
  {
    name: 'Data Processing Scripts',
    description: 'ETL pipeline for violation and speed data',
    files: 'Python/Pandas',
    link: '/scripts/'
  },
  {
    name: 'Visualization Code',
    description: 'Interactive charts and map generation',
    files: 'D3.js/Leaflet',
    link: '/src/components/charts/'
  }
];
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  keywords="MTA data analysis, bus violation research, CUNY transportation study, enforcement paradox methodology"
>
  <Header currentPath="/methodology" />

  <main id="main-content">
    <!-- Hero Section -->
    <Hero
      title="How We Built the Case"
      subtitle="Research Methodology"
      description="Transparent documentation of our data science approach: analyzing 3.7 million violation records to prove that targeted enforcement can protect student study time."
      ctaText="View Analysis Code"
      ctaHref="#code-repositories"
      secondaryCtaText="See Key Findings"
      secondaryCtaHref="/findings"
      variant="data"
    >
      <div slot="visual">
        <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-6 border border-white/20">
          <h3 class="text-lg font-semibold text-white mb-4">Analysis Pipeline</h3>
          <div class="space-y-3">
            <div class="flex items-center text-sm text-white/90">
              <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center mr-3 text-xs font-semibold">1</div>
              <span>3.7M violation records ‚Üí spatial mapping</span>
            </div>
            <div class="flex items-center text-sm text-white/90">
              <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center mr-3 text-xs font-semibold">2</div>
              <span>Temporal pattern analysis ‚Üí peak hours</span>
            </div>
            <div class="flex items-center text-sm text-white/90">
              <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center mr-3 text-xs font-semibold">3</div>
              <span>CUNY proximity ‚Üí student impact</span>
            </div>
            <div class="flex items-center text-sm text-white/90">
              <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center mr-3 text-xs font-semibold">4</div>
              <span>Enforcement paradox ‚Üí solution targets</span>
            </div>
          </div>
        </div>
      </div>
    </Hero>

    <!-- Data Sources Section -->
    <section class="py-16 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-16">
          <h2 class="text-3xl font-bold text-gray-900 mb-4">
            Data Sources & Scale
          </h2>
          <p class="text-xl text-gray-600 max-w-3xl mx-auto">
            Our analysis combines multiple authoritative datasets to create the most comprehensive
            picture of bus enforcement patterns and their impact on student commutes.
          </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {dataSources.map((source, index) => (
            <Card variant="elevated" hover={true} key={source.name}>
              <div class="flex items-start space-x-4">
                <div class="flex-shrink-0">
                  <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center">
                    <span class="text-primary font-bold text-lg">{index + 1}</span>
                  </div>
                </div>
                <div class="flex-1">
                  <h3 class="text-lg font-semibold text-gray-900 mb-2">{source.name}</h3>
                  <div class="flex flex-wrap gap-4 text-sm text-gray-600 mb-3">
                    <span class="font-semibold text-primary">{source.records} records</span>
                    <span>{source.timeframe}</span>
                    <span class="bg-gray-100 px-2 py-1 rounded">{source.source}</span>
                  </div>
                  <p class="text-gray-600">{source.description}</p>
                </div>
              </div>
            </Card>
          ))}
        </div>

        <div class="mt-12 p-8 bg-gray-50 rounded-2xl">
          <h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">
            Data Quality & Validation
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
            <div>
              <div class="text-2xl font-bold text-green-600 mb-2">97.8%</div>
              <div class="text-sm text-gray-600">Spatial match rate</div>
            </div>
            <div>
              <div class="text-2xl font-bold text-green-600 mb-2">99.2%</div>
              <div class="text-sm text-gray-600">Temporal data completeness</div>
            </div>
            <div>
              <div class="text-2xl font-bold text-green-600 mb-2">100%</div>
              <div class="text-sm text-gray-600">CUNY location accuracy</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Analysis Pipeline Section -->
    <section class="py-16 bg-gray-50 print-break-before">
      <DataVisualizationLayout
        title="Analysis Pipeline"
        description="Step-by-step breakdown of our methodology, from raw data to actionable insights."
        layout="story"
      >
        <div class="space-y-12">
          {analysisSteps.map((step, index) => (
            <div key={step.step} class="relative">
              {/* Connection line */}
              {index < analysisSteps.length - 1 && (
                <div class="absolute left-6 top-16 w-0.5 h-16 bg-gray-300 hidden sm:block"></div>
              )}

              <div class="flex flex-col sm:flex-row gap-6 items-start">
                {/* Step indicator */}
                <div class="flex-shrink-0">
                  <div class="w-12 h-12 bg-primary rounded-xl flex items-center justify-center text-white font-bold text-xl">
                    {step.step}
                  </div>
                </div>

                {/* Step content */}
                <Card variant="elevated" className="flex-1">
                  <div class="flex items-start space-x-4">
                    <div class="text-3xl">{step.icon}</div>
                    <div class="flex-1">
                      <h3 class="text-xl font-semibold text-gray-900 mb-3">{step.title}</h3>
                      <p class="text-gray-600 mb-4">{step.description}</p>
                      <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm font-medium text-gray-700 mb-1">Technical Implementation:</div>
                        <div class="text-sm text-gray-600 font-mono">{step.technical}</div>
                      </div>
                    </div>
                  </div>
                </Card>
              </div>
            </div>
          ))}
        </div>

        {/* Statistical Methods */}
        <div class="mt-16 bg-white rounded-2xl p-8 border border-gray-200">
          <h3 class="text-2xl font-bold text-gray-900 mb-6">Statistical Methods</h3>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div>
              <h4 class="text-lg font-semibold text-gray-900 mb-3">Significance Testing</h4>
              <ul class="space-y-2 text-gray-600">
                <li>‚Ä¢ Chi-square tests for categorical associations</li>
                <li>‚Ä¢ Mann-Whitney U tests for non-parametric comparisons</li>
                <li>‚Ä¢ Bonferroni correction for multiple comparisons</li>
                <li>‚Ä¢ Bootstrap confidence intervals (n=10,000)</li>
              </ul>
            </div>

            <div>
              <h4 class="text-lg font-semibold text-gray-900 mb-3">Spatial Analysis</h4>
              <ul class="space-y-2 text-gray-600">
                <li>‚Ä¢ Haversine distance calculations</li>
                <li>‚Ä¢ K-means clustering for hotspot identification</li>
                <li>‚Ä¢ Moran's I for spatial autocorrelation</li>
                <li>‚Ä¢ Buffer analysis with 50m, 100m, 500m tolerances</li>
              </ul>
            </div>
          </div>
        </div>
      </DataVisualizationLayout>
    </section>

    <!-- Code Repositories Section -->
    <section id="code-repositories" class="py-16 bg-white">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-3xl font-bold text-gray-900 mb-4">
            Reproducible Research
          </h2>
          <p class="text-xl text-gray-600">
            All analysis code and documentation is available for verification and replication.
          </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
          {codeRepositories.map((repo) => (
            <Card variant="outlined" hover={true} key={repo.name} className="text-center">
              <div class="text-3xl mb-4">üìÅ</div>
              <h3 class="text-lg font-semibold text-gray-900 mb-2">{repo.name}</h3>
              <p class="text-gray-600 mb-3">{repo.description}</p>
              <div class="text-sm text-gray-500 mb-4">{repo.files}</div>
              <Button href={repo.link} variant="outline" size="sm">
                View Code
              </Button>
            </Card>
          ))}
        </div>

        <div class="bg-primary/5 rounded-2xl p-8 text-center border border-primary/10">
          <h3 class="text-xl font-semibold text-gray-900 mb-4">
            Academic Collaboration Welcome
          </h3>
          <p class="text-gray-600 mb-6">
            We encourage academic researchers to build on our work. All data processing code,
            statistical methods, and visualization components are documented for replication.
          </p>
          <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <Button href="/contact" variant="primary">
              üìß Collaborate With Us
            </Button>
            <Button href="/findings" variant="secondary">
              üìä View Results
            </Button>
          </div>
        </div>
      </div>
    </section>

    <!-- Limitations & Future Work -->
    <section class="py-16 bg-gray-50">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-3xl font-bold text-gray-900 mb-4">
            Limitations & Future Directions
          </h2>
          <p class="text-xl text-gray-600">
            Transparent acknowledgment of constraints and opportunities for expansion.
          </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <Card variant="default" className="h-full">
            <h3 class="text-xl font-semibold text-red-800 mb-4">Current Limitations</h3>
            <ul class="space-y-3 text-gray-600">
              <li class="flex items-start">
                <div class="w-2 h-2 bg-red-400 rounded-full mt-2 mr-3 flex-shrink-0"></div>
                <span>Weather and seasonal variations not fully modeled</span>
              </li>
              <li class="flex items-start">
                <div class="w-2 h-2 bg-red-400 rounded-full mt-2 mr-3 flex-shrink-0"></div>
                <span>Individual student commute patterns estimated from aggregate data</span>
              </li>
              <li class="flex items-start">
                <div class="w-2 h-2 bg-red-400 rounded-full mt-2 mr-3 flex-shrink-0"></div>
                <span>Long-term academic impact requires longitudinal study</span>
              </li>
              <li class="flex items-start">
                <div class="w-2 h-2 bg-red-400 rounded-full mt-2 mr-3 flex-shrink-0"></div>
                <span>Cost-benefit analysis based on estimated enforcement costs</span>
              </li>
            </ul>
          </Card>

          <Card variant="default" className="h-full">
            <h3 class="text-xl font-semibold text-green-800 mb-4">Future Enhancements</h3>
            <ul class="space-y-3 text-gray-600">
              <li class="flex items-start">
                <div class="w-2 h-2 bg-green-400 rounded-full mt-2 mr-3 flex-shrink-0"></div>
                <span>Real-time violation prediction using machine learning</span>
              </li>
              <li class="flex items-start">
                <div class="w-2 h-2 bg-green-400 rounded-full mt-2 mr-3 flex-shrink-0"></div>
                <span>Student survey integration for commute pattern validation</span>
              </li>
              <li class="flex items-start">
                <div class="w-2 h-2 bg-green-400 rounded-full mt-2 mr-3 flex-shrink-0"></div>
                <span>Pilot program impact measurement framework</span>
              </li>
              <li class="flex items-start">
                <div class="w-2 h-2 bg-green-400 rounded-full mt-2 mr-3 flex-shrink-0"></div>
                <span>Expansion to other educational institution networks</span>
              </li>
            </ul>
          </Card>
        </div>

        <div class="mt-12 text-center">
          <p class="text-gray-600 mb-6">
            Have suggestions for improving our methodology? We welcome feedback from researchers,
            policymakers, and fellow students.
          </p>
          <Button href="/contact#feedback" variant="outline" size="lg">
            üìù Provide Feedback
          </Button>
        </div>
      </div>
    </section>
  </main>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Add copy-to-clipboard for technical details
    const technicalDetails = document.querySelectorAll('.font-mono');
    technicalDetails.forEach(detail => {
      detail.style.cursor = 'pointer';
      detail.title = 'Click to copy';

      detail.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(detail.textContent || '');

          // Visual feedback
          const originalText = detail.textContent;
          detail.textContent = '‚úì Copied!';
          detail.style.color = 'green';

          setTimeout(() => {
            detail.textContent = originalText;
            detail.style.color = '';
          }, 2000);

        } catch (err) {
          console.error('Failed to copy text:', err);
        }
      });
    });

    // Track methodology engagement
    const sections = document.querySelectorAll('section');
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && typeof gtag !== 'undefined') {
          const sectionTitle = entry.target.querySelector('h2, h3')?.textContent;
          if (sectionTitle) {
            gtag('event', 'methodology_section_view', {
              section_title: sectionTitle,
              engagement_type: 'deep_read'
            });
          }
        }
      });
    }, { threshold: 0.5 });

    sections.forEach(section => observer.observe(section));

    // Track code repository clicks
    const codeLinks = document.querySelectorAll('a[href*="/notebooks"], a[href*="/scripts"], a[href*="/components"]');
    codeLinks.forEach(link => {
      link.addEventListener('click', () => {
        if (typeof gtag !== 'undefined') {
          gtag('event', 'code_repository_access', {
            repository_type: link.href.includes('notebooks') ? 'jupyter' :
                            link.href.includes('scripts') ? 'python' : 'visualization',
            access_source: 'methodology_page'
          });
        }
      });
    });
  });
</script>